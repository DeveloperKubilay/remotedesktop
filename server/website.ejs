<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
<style>
  body {
    margin: 0;
    overflow: hidden; 
  }
  img {
    width: 100vw; 
    height: 100vh; 
    object-fit: cover; 
  }
</style>
</head>
<body>
    <script>
      var process = {}
      var autoq = true;
      var ping = 0
      var quality = 100
      var interval = ""
      var machine = "<%= machine %>"
      function startstream(){}
      document.addEventListener("DOMContentLoaded", function() {
const socket = io({
    auth:{auth:"a1"}
});

var mousemove = false;

startstream = function(x,c){
  if(c){
    autoq = false;
    socket.emit("adminmessage",{
    machine:machine,
    quality:Number(x)
  });
  }else{
clearInterval(interval);
interval = setInterval(()=>{
  if(autoq){
    if(ping > 1000) quality -= 1 
    if(ping < 500) quality += 1 

    if(quality < 0) quality = 1
    socket.emit("adminmessage",{
    machine:machine,
    quality:quality
  });
  }
  socket.emit("adminmessage",{
    machine:machine,
    screenshot:true,
    time:Date.now()
  });
},x || 100)
}
}
startstream()

socket.on('adminmessagec', data => {
  if(data.machine != machine) return;
  if(data.screenshot){
    const base64Data = data.screenshot;
    const blob = new Blob([base64Data], { type: 'image/png' });
    const imageUrl = URL.createObjectURL(blob);
    document.getElementById('screenshotImg').src = imageUrl;
    ping = Date.now()-data.time
    quality = data.quality
    document.getElementById("pingg").innerHTML = "Ping:"+ping+"ms"
  }
  if(data.process){
    process = data.process
  }

});




document.getElementById('screenshotImg').addEventListener("click",function(event){
    socket.emit("adminmessage",{ machine:machine,click:[event.clientX,event.clientY]})
})
document.getElementById('screenshotImg').addEventListener("contextmenu",function(event){
    socket.emit("adminmessage",{ machine:machine,click:[event.clientX,event.clientY,'right']})
})
document.getElementById('screenshotImg').addEventListener("mousedown",function(event){
  if (event.button === 1) { socket.emit("adminmessage",{ machine:machine,click:[event.clientX,event.clientY,'middle']})}
})
document.getElementById('screenshotImg').addEventListener("wheel", function(event) {
  socket.emit("adminmessage",{ machine:machine,scroll:event.deltaY})
});
document.getElementById('screenshotImg').addEventListener("mousemove",function(event){
  if(!mousemove) return;
    socket.emit("adminmessage",{ machine:machine,move:[event.clientX,event.clientY]})
})
window.addEventListener("keypress",function(event){
    socket.emit("adminmessage",{ machine:machine,keypress:event.key})
})

var filename = ""


document.getElementById('fileInput').addEventListener("change",function(event){
  var fileInput = event.target
  var file = fileInput.files[0];
  if (file) { socket.emit("adminmessage",{ machine:machine,file:[filename,file]})}
})

document.getElementById('execa').addEventListener("click",function(event){
  const userInput = prompt("Exec:");
if (userInput !== null) {
 socket.emit("adminmessage",{ machine:machine,exec:userInput})
}})

document.getElementById('filea').addEventListener("click",function(event){
  const userInput = prompt("Filename:");
if (userInput !== null) {
  filename = userInput
  document.getElementById('fileInput').click()
}})

document.getElementById('killa').addEventListener("click",function(event){socket.emit("adminmessage",{ machine:machine,kill:true})})
document.getElementById('movemousea').addEventListener("click",function(event){mousemove = !mousemove})

});



        </script>
  <img id="screenshotImg">
  <input type="file" name="file" id="fileInput" >
  <button style="left:0;top:0;position: absolute;" id="execa">Exec</button>
  <button style="left:50px;top:0;position: absolute;" id="filea" >File</button>
  <button style="top:0;left:95px;position: absolute;" id="killa" >Kill</button>
  <button style="top:0;left:140px;position: absolute;" id="movemousea" >Movemouse</button>
  <button style="top:0;left:240px;position: absolute;" onclick="navigator.clipboard.writeText(JSON.stringify(process,null,2))" >Copy process</button>
  <button style="top:0;left:350px;position: absolute;" onclick="startstream(prompt('FPS:'))" >Restream</button>
  <button style="top:0;left:450px;position: absolute;" onclick="startstream(prompt('0 to 100:'),'q')" >Quality</button>
  <a style="top:0;left:550px;position: absolute;color:red" id="pingg" >Ping</a>
</body>
</html>
